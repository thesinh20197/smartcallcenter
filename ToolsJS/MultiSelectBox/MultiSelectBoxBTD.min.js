var EventNameMSB={click:"click",blur:"blur",focus:"focus",change:"change",ok:"ok",itemClick:"itemClick",itemMouseOver:"itemMouseOver",itemMouseMove:"itemMouseMove",itemMouseOut:"itemMouseOut"};MultiSelectBoxBTD=function(idParent,configData,myName,myStyle,isCbo){if(idParent==null)return;this.myName=myName;this.myStyle=typeof(myStyle)=="undefined"?"":myStyle;this.heightItem=19;this.isSearch=false;this.heightTbxSearch=0;this.elSearchInput=null;this.isBTD=true;this.maxItem=configData.maxItem==null?20:configData.maxItem;this.elContainerList=null;this.elContainer=null;this.oTableList=null;this.elContainerTable=null;this.oBtnOK=null;if(typeof(isCbo)=="undefined"||!isCbo){this.elContainerParent=typeof(idParent)=="string"?utilObj.getElById(idParent):idParent;this.configData=utilObj.cloneObject(configData);}
else{var oCbo=typeof(idParent)=="string"?utilObj.getElById(idParent):idParent;this.elContainerParent=oCbo.parentNode;this.configData=null;this.createListFromCbo(oCbo);this.elContainerParent.removeChild(oCbo);}
this.listEvent=new Array();this.itemSelected=null;this.oldValue="";this.oldElRow=null;this.textCheckAll="(Tất cả)";this.textSeparator=configData.textSeparator==null?"; ":configData.textSeparator;this.isTextBoxReadOnly=true;this.isReadOnly=false;this.enabledAutoCom=true;this.isMultiSelect=false;if(this.elContainerParent!=null)this.createMain();var self=this;this.alreadyKeyDown=false;this.whenKeyDown=function(e){self.documentKeyDownMSB(e);};};MultiSelectBoxBTD.prototype.createMain=function(){try{this.createContainer();var self=this;utilObj.addEvent(document,"mousedown",function(e){self.documentMouseDown(e);});utilObj.addEvent(document,"keydown",function(e){if(e.keyCode=="27"){self.hideList(e);}});utilObj.addEvent(window,"resize",function(e){});utilObj.addEvent(document,"scroll",function(e){self.hideList(e);});}
catch(e)
{}};MultiSelectBoxBTD.prototype.setWidth=function(w){w+="";w=(w.indexOf("%",0)==-1)?((w.indexOf("px",0)==-1)?w+"px":w):w;if(this.elContainer!=null){this.elContainer.style.width=w;}};MultiSelectBoxBTD.prototype.getPositionView=function(){return utilObj.getElementPositionView(this.elContainer);};MultiSelectBoxBTD.prototype.getSize=function(){return utilObj.getElementSize(this.elContainer);};MultiSelectBoxBTD.prototype.setReadOnly=function(isReadOnly){this.isReadOnly=isReadOnly;this.oTextBox.readOnly=isReadOnly;this.oTextBox.disabled=isReadOnly;};MultiSelectBoxBTD.prototype.createContainer=function(){this.elContainer=utilObj.createEl("DIV");this.elContainer.id="containerMSB_"+this.myName;this.elContainer.className="containerMSB"+this.myStyle;this.elContainerParent.appendChild(this.elContainer);this.createTextBox();this.createButton();this.createContainerList();};MultiSelectBoxBTD.prototype.createTextBox=function(){var o=utilObj.createEl("INPUT");o.className="displayText";o.readOnly=this.isTextBoxReadOnly;o.nameMSB=this.myName;if(this.configData.textPlaceholder!=null&&this.configData.textPlaceholder!=''){o.placeholder=this.configData.textPlaceholder;}
var self=this;utilObj.addEvent(o,"mouseover",function(e){self.mouseOverDDL(e);});utilObj.addEvent(o,"mouseout",function(e){self.mouseOutDDL(e);});utilObj.addEvent(o,"click",function(e){self.mouseClickDDL(e);});utilObj.addEvent(o,"focus",function(e){self.executeEvent(e,EventNameMSB.focus);});utilObj.addEvent(o,"blur",function(e){self.executeEvent(e,EventNameMSB.blur);});this.oTextBox=o;this.elContainer.appendChild(o);};MultiSelectBoxBTD.prototype.createButton=function(){var o=utilObj.createEl("DIV");o.id="btn_"+this.myName;o.className="btn";o.nameMSB=this.myName;var self=this;utilObj.addEvent(o,"mouseover",function(e){self.mouseOverDDL(e);});utilObj.addEvent(o,"mouseout",function(e){self.mouseOutDDL(e);});utilObj.addEvent(o,"click",function(e){self.mouseClickDDL(e);});this.oBtn=o;this.elContainer.appendChild(o);};MultiSelectBoxBTD.prototype.createButtonOK=function(){var o=utilObj.createEl("DIV");o.className="cButtonOK";o.nameMSB=this.myName;var elInput=utilObj.createEl("INPUT");elInput.type='button';elInput.nameMSB=this.myName;elInput.value='OK';o.appendChild(elInput);var self=this;utilObj.addEvent(elInput,"click",function(e){self.executeEvent(e,EventNameMSB.ok);});this.oBtnOK=o;this.elContainerList.appendChild(o);};MultiSelectBoxBTD.prototype.createTextBoxSearch=function(){var elContainer=utilObj.createEl("DIV");elContainer.className="containerSearch";elContainer.nameMSB=this.myName;var elInput=utilObj.createEl("INPUT");elInput.className="searchInput";elInput.nameMSB=this.myName;var self=this;utilObj.addEvent(elInput,"keydown",function(e){self.searchKeyDown(e);});utilObj.addEvent(elInput,"focus",function(e){self.searchKeyDown(e);});utilObj.addEvent(elInput,"blur",function(e){self.searchBlur(e);});this.elSearchInput=elInput;elContainer.appendChild(elInput);this.elContainerList.appendChild(elContainer);};MultiSelectBoxBTD.prototype.createContainerList=function(){this.elContainerList=utilObj.createEl("DIV");this.elContainerList.id="ListMSB_"+this.myName;this.elContainerList.className="listMSB";this.elContainerList.nameMSB=this.myName;this.elContainerList.style.display="none";this.elContainerList.style.top="-1000px";this.elContainerList.style.left="-1000px";utilObj.addChildToBody(this.elContainerList);this.createTextBoxSearch();this.createList();if(this.configData.isShowButtonOK){this.createButtonOK();}};MultiSelectBoxBTD.prototype.createList=function(){var elContainerTable=utilObj.createEl("DIV");elContainerTable.className="cTableMSB";elContainerTable.nameMSB=this.myName;this.elContainerTable=elContainerTable;this.oTableList=utilObj.createEl("TABLE");this.oTableList.id="tableListMSB_"+this.myName;this.oTableList.className="tableInList";this.oTableList.nameMSB=this.myName;this.oTableList.style.visibility="visible";elContainerTable.appendChild(this.oTableList);this.elContainerList.appendChild(elContainerTable);this.createTBodyList();};MultiSelectBoxBTD.prototype.createTBodyList=function(){this.createCheckAll();for(var i=0;i<this.configData.data.length;i++){this.insertRow(this.configData.data[i]);}
this.whenSelectBoxChange();this.oldValue=this.oTextBox.value;};MultiSelectBoxBTD.prototype.insertRow=function(item){var elRow=this.oTableList.insertRow(this.oTableList.rows.length);elRow.isCheckAll=false;elRow.item=item;item.elRow=elRow;elRow.nameMSB=this.myName;elRow.className="item";var elCell=elRow.insertCell(elRow.cells.length);elCell.nameMSB=this.myName;elCell.style.width="25px";elCell.elementChk=utilObj.createEl("INPUT");elCell.elementChk.type="CHECKBOX";elCell.elementChk.nameMSB=this.myName;elCell.appendChild(elCell.elementChk);if(elRow.item[this.configData.mapField.checked]){elCell.elementChk.checked=true;}
if(this.configData.mapField.color!=null){var elCell=elRow.insertCell(elRow.cells.length);elCell.nameMSB=this.myName;elCell.style.width="25px";elCell.elColor=utilObj.createEl("DIV");elCell.elColor.nameMSB=this.myName;elCell.appendChild(elCell.elColor);elCell.elColor.style.border="1px solid #808080";elCell.elColor.style.fontSize="0px";elCell.elColor.style.width="15px";elCell.elColor.style.height="15px";elCell.elColor.style.margin="auto";elCell.elColor.style.backgroundColor="#"+elRow.item[this.configData.mapField.color];}
for(var i=0;i<this.configData.mapField.display.length;i++){this.insertCell(elRow,this.configData.mapField.display[i]);}
this.mapEventForRow(elRow);if(this.oTableList.rows.length==1){this.heightItem=utilObj.getElementSize(elRow.cells[0]).height;}};MultiSelectBoxBTD.prototype.insertCell=function(elRow,oCol){elCell=elRow.insertCell(elRow.cells.length);if(oCol.width!=null){elCell.style.minWidth=oCol.width+"px";}
elCell.nameMSB=this.myName;var elValue=document.createElement('DIV');elCell.element=elValue;elValue.nameMSB=this.myName;elValue.title=elValue.innerHTML=elRow.item[oCol.field];elCell.appendChild(elValue);};MultiSelectBoxBTD.prototype.addItem=function(item){this.configData.data.push(item);this.insertRow(item);};MultiSelectBoxBTD.prototype.updateItem=function(item){var list=this.configData.data;for(var i=0;i<list.length;i++){if(item[this.configData.mapField.value]==list[i][this.configData.mapField.value]){for(var key in item){if(list[i][key]!=null){list[i][key]=item[key];}}
var elRow=list[i].elRow;var delta=1+(this.configData.mapField.color!=null?1:0);for(var k=0;k<this.configData.mapField.display.length;k++){var oCol=this.configData.mapField.display[k];elRow.cells[k+delta].element.innerHTML=elRow.item[oCol.field];}
break;}}};MultiSelectBoxBTD.prototype.removeItem=function(value){var list=this.configData.data;for(var i=0;i<list.length;i++){if(value==list[i][this.configData.mapField.value]){this.oTableList.tBodies[0].removeChild(list[i].elRow);list.splice(i,1);break;}}};MultiSelectBoxBTD.prototype.removeListItem=function(arrValue){var dic=utilObj.convertArrayToDictionary(arrValue);var list=this.configData.data;for(var i=0;i<list.length;i++){if(dic[list[i][this.configData.mapField.value]+'']!=null){this.oTableList.tBodies[0].removeChild(list[i].elRow);list.splice(i,1);i--;}}};MultiSelectBoxBTD.prototype.createCheckAll=function(){var elRow=this.oTableList.insertRow(this.oTableList.rows.length);elRow.nameMSB=this.myName;elRow.isCheckAll=true;elRow.className="item";this.mapEventForRow(elRow);elCell=elRow.insertCell(elRow.cells.length);elCell.nameMSB=this.myName;elCell.colSpan=this.configData.mapField.display.length+1+(this.configData.mapField.color!=null?1:0);elCell.elementChk=utilObj.createEl("INPUT");elCell.elementChk.type="CHECKBOX";elCell.elementChk.nameMSB=this.myName;elCell.appendChild(elCell.elementChk);elCell.appendChild(utilObj.createElText(this.textCheckAll));};MultiSelectBoxBTD.prototype.searchKeyDown=function(e){this.isSearch=true;if(!this.alreadyKeyDown){this.alreadyKeyDown=true;utilObj.addEvent(document,"keydown",this.whenKeyDown);}};MultiSelectBoxBTD.prototype.searchBlur=function(e){this.isSearch=false;};MultiSelectBoxBTD.prototype.changeCssElRow=function(elRow){elRow.className=elRow.cells[0].elementChk.checked?"item_selected":"item";};MultiSelectBoxBTD.prototype.changeCheckBoxAll=function(){var textDisplay="";var elRow=this.oTableList.rows[0];this.changeCssElRow(elRow);var isAll=elRow.cells[0].elementChk.checked;for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];if(item.elRow.style.display==''){var elCell=item.elRow.cells[0];elCell.elementChk.checked=isAll;this.changeCssElRow(item.elRow);if(elCell.elementChk.checked){if(textDisplay!="")textDisplay+=this.textSeparator;textDisplay+=item[this.configData.mapField.text];}}}
this.oTextBox.value=textDisplay;};MultiSelectBoxBTD.prototype.whenSelectBoxChange=function(){var isAll=true;var textDisplay="";for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];var elCell=item.elRow.cells[0];if(!elCell.elementChk.checked){isAll=false;}
else{if(textDisplay!="")textDisplay+=this.textSeparator;textDisplay+=item[this.configData.mapField.text];}
this.changeCssElRow(item.elRow);}
this.oTextBox.value=textDisplay;var elRowCheckAll=this.oTableList.rows[0];elRowCheckAll.cells[0].elementChk.checked=isAll;this.changeCssElRow(elRowCheckAll);};MultiSelectBoxBTD.prototype.mouseOverItem=function(elRow,e){this.oldElRow=elRow;elRow.className="item_over";};MultiSelectBoxBTD.prototype.mouseOutItem=function(elRow,e){this.changeCssElRow(elRow);};MultiSelectBoxBTD.prototype.clickItem=function(elRow,e){var elTarget=utilObj.getTargetElement();if(elTarget.nameMSB==this.myName){if(elTarget.tagName!='INPUT'){elRow.cells[0].elementChk.checked=!elRow.cells[0].elementChk.checked;}}
if(elRow.isCheckAll)this.changeCheckBoxAll();else this.whenSelectBoxChange();};MultiSelectBoxBTD.prototype.documentMouseDown=function(e){var o=utilObj.getTargetElement();if(typeof(o.nameMSB)!="undefined"&&o.nameMSB==this.myName){return;}
this.hideList(e);};MultiSelectBoxBTD.prototype.documentKeyDownMSB=function(e){e=utilObj.getWindowEvent();switch(e.keyCode){case 38:break;case 40:break;case 13:case 9:utilObj.stopEvent();break;default:var self=this;if(this.isSearch){setTimeout(function(){self.toComplete();},50);}
break;}
return false;};MultiSelectBoxBTD.prototype.toComplete=function(){var isSelected=false;var vSearch=this.elSearchInput.value.toUpperCase();var arrVSearch=vSearch.split(" ");for(var i=0;i<this.configData.data.length;i++){var elRow=this.configData.data[i].elRow;var arrFieldSearch=[];var isFound=false;if(typeof this.configData.mapField.search=="string"){arrFieldSearch.push(this.configData.mapField.search);}
else{arrFieldSearch=this.configData.mapField.search;}
var countK=0;for(var k=0;k<arrVSearch.length;k++){for(var j=0;j<arrFieldSearch.length;j++){var v=this.configData.data[i][arrFieldSearch[j]];if(v==null)continue;var v=v.toUpperCase();if(v.indexOf(arrVSearch[k],0)!=-1){countK++;break;}}}
isFound=countK==arrVSearch.length;if(isFound){elRow.style.display="";}
else{elRow.style.display="none";}}
this.calcWidth();};MultiSelectBoxBTD.prototype.mouseOverDDL=function(e){this.oBtn.className="btn_over";};MultiSelectBoxBTD.prototype.mouseOutDDL=function(e){this.oBtn.className="btn";};MultiSelectBoxBTD.prototype.mouseClickDDL=function(e){if(this.isReadOnly)return;this.showList(e);this.elSearchInput.focus();this.executeEvent(e,EventNameMSB.click);};MultiSelectBoxBTD.prototype.mapEventForRow=function(elRow){var self=this;elRow["onclick"]=function(e){e=utilObj.getWindowEvent();e.item=elRow.item;self.clickItem(elRow,e);self.executeEvent(e,EventNameMSB.itemClick);};elRow["onmouseover"]=function(e){e=utilObj.getWindowEvent();e.item=elRow.item;self.mouseOverItem(elRow,e);self.executeEvent(e,EventNameMSB.itemMouseOver);};elRow["onmouseout"]=function(e){e=utilObj.getWindowEvent();e.item=elRow.item;self.mouseOutItem(elRow,e);self.executeEvent(e,EventNameMSB.itemMouseOut);};};MultiSelectBoxBTD.prototype.addEvent=function(eventName,func){if(this.listEvent[eventName]==null){this.listEvent[eventName]=[];}
this.listEvent[eventName].push(func);};MultiSelectBoxBTD.prototype.removeEvent=function(eventName,func){if(this.listEvent[eventName]==null){return;}
for(var i=0;i<this.listEvent[eventName].length;i++){if(func==this.listEvent[eventName][i]){this.listEvent[eventName].splice(i,1);break;}}};MultiSelectBoxBTD.prototype.executeEvent=function(e,eventName){if(this.listEvent[eventName]!=null){for(var i=0;i<this.listEvent[eventName].length;i++){this.listEvent[eventName][i](e);}}};MultiSelectBoxBTD.prototype.clearListItems=function(){this.configData.data=[];while(this.oTableList.rows.length>0){this.oTableList.deleteRow(0);}
this.oTextBox.value="";};MultiSelectBoxBTD.prototype.isExistItem=function(value){var list=this.configData.data;var isExist=false;for(var i=0;i<list.length;i++){if(list[i][this.configData.mapField.value]==value){isExist=true;break;}}
return isExist;};MultiSelectBoxBTD.prototype.createListFromCbo=function(oCbo){this.configData={mapField:{value:"value",text:"text",checked:"selected",display:[{field:"text"}]},data:[]};for(var i=0;i<oCbo.length;i++){this.configData.data.push({value:oCbo[i].value,text:oCbo[i].text,selected:oCbo[i].selected});}};MultiSelectBoxBTD.prototype.gotoItem=function(isUp){var rowIndex=0;if(this.oldElRow!=null){rowIndex=this.oldElRow.rowIndex;if((rowIndex==0&&isUp)||(rowIndex==this.oTableList.rows.length-1&&!isUp))return;this.oldElRow.className="item";if(isUp){rowIndex--;this.oldElRow=this.oldElRow.previousSibling;}
else{this.oldElRow=this.oldElRow.nextSibling;rowIndex++;}}
else{if(this.oTableList.rows.length>0){this.oldElRow=this.oTableList.rows[0];rowIndex=this.oldElRow.rowIndex;}}
if(this.oldElRow!=null){var curentPos=rowIndex*this.heightItem;var startPos=this.elContainerList.scrollTop;var endPos=startPos+(this.maxItem*this.heightItem);if(startPos>curentPos||endPos<=curentPos){var scrollDown=curentPos-(this.maxItem*this.heightItem)+this.heightItem;this.elContainerList.scrollTop=isUp?curentPos:(scrollDown<0?0:scrollDown);}
this.itemSelected=this.oldElRow.item;this.oldElRow.className="item_over";this.oTextBox.value=this.oldElRow.item[this.configData.mapField.text];this.oTextBox.select();}};MultiSelectBoxBTD.prototype.calcPosition=function(){var sizeParent=utilObj.getElementSize(this.elContainer);var sizeChild=utilObj.getElementSize(this.elContainerList);var docScroll=utilObj.getDocumentScroll();var pos=utilObj.getElementPositionView(this.elContainer);var sizeClient=utilObj.getDocument();if((pos.Y+sizeParent.height+sizeChild.height-docScroll.scrollTop)>sizeClient.clientHeight){pos.Y-=sizeChild.height+2;}
else{pos.Y+=sizeParent.height-1;}
if(sizeChild.width>sizeClient.clientWidth){pos.X=docScroll.scrollLeft;}
else if(pos.X+sizeChild.width>sizeClient.clientWidth+docScroll.scrollLeft){pos.X=sizeClient.clientWidth+docScroll.scrollLeft-sizeChild.width;}
this.elContainerList.style.top=pos.Y+"px";this.elContainerList.style.left=pos.X+"px";};MultiSelectBoxBTD.prototype.calcWidth=function(){var minWidth=utilObj.getElementSize(this.elContainer).width;var sizeTableList=utilObj.getElementSize(this.oTableList);var w=sizeTableList.width+17<minWidth?minWidth:sizeTableList.width;var maxHeight=(this.maxItem*this.heightItem);this.elContainerTable.style.maxHeight=maxHeight+"px";if(sizeTableList.height>maxHeight){this.oTableList.style.width=(utilObj.isEE?w-17:w)+"px";w=w+17;}
else{this.oTableList.style.width=(w<0?0:w)+"px";}
this.elContainerTable.style.width=this.elContainerList.style.width=w+"px";};MultiSelectBoxBTD.prototype.showList=function(e){this.elContainerList.style.display="";this.oTableList.style.width="0px";this.calcWidth();this.calcPosition();};MultiSelectBoxBTD.prototype.hideList=function(e){if(this.elContainerList==null)return;this.elContainerList.style.display="none";this.elContainerList.style.top="-1000px";this.elContainerList.style.left="-1000px";if(this.oldValue!=this.oTextBox.value){this.oldValue=this.oTextBox.value;this.executeEvent(e,EventNameMSB.change);}
this.isSearch=false;if(this.alreadyKeyDown){this.alreadyKeyDown=false;utilObj.removeEvent(document,"keydown",this.whenKeyDown);}};MultiSelectBoxBTD.prototype.dispose=function(){this.elContainerParent.removeChild(this.elContainer);this.elContainerList=null;this.elContainer=null;};MultiSelectBoxBTD.prototype.reset=function(){this.selectedValues([]);};MultiSelectBoxBTD.prototype.reloadData=function(configData){if(this.elContainerTable!=null){this.configData=utilObj.cloneObject(configData);this.maxItem=this.configData.maxItem==null?20:this.configData.maxItem;this.textSeparator=this.configData.textSeparator==null?"; ":this.configData.textSeparator;this.elContainerList.removeChild(this.elContainerTable);this.createList();this.oTextBox.value='';}};MultiSelectBoxBTD.prototype.getListItemSelected=function(){var re=new Array();for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];if(item.elRow.cells[0].elementChk.checked){re.push(item);}}
return re;};MultiSelectBoxBTD.prototype.getValue=function(useQuote){var values="";for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];if(item.elRow.cells[0].elementChk.checked){if(values!="")values+=this.textSeparator;if(useQuote!=null&&useQuote){values+="'"+item[this.configData.mapField.value]+"'";}
else{values+=item[this.configData.mapField.value];}}}
return values;};MultiSelectBoxBTD.prototype.getValueArray=function(){var values=new Array();for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];if(item.elRow.cells[0].elementChk.checked){values.push(item[this.configData.mapField.value]);}}
return values;};MultiSelectBoxBTD.prototype.getText=function(){return this.oTextBox.value;};MultiSelectBoxBTD.prototype.selectedValues=function(values,useQuote){if(typeof(values)=='string'){var arr=values.split(',');if(arr.length==1){arr=values.split(';');}
values={};for(var i=0;i<arr.length;i++){values[arr[i]]=arr[i];}}
var isAll=true;var textDisplay="";for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];var elCell=item.elRow.cells[0];var isChecked=values[item[this.configData.mapField.value]+""]!=null;if(useQuote!=null&&useQuote){isChecked=values["'"+item[this.configData.mapField.value]+"'"]!=null;}
elCell.elementChk.checked=isChecked;if(!elCell.elementChk.checked){isAll=false;}
else{if(textDisplay!="")textDisplay+=this.textSeparator;textDisplay+=item[this.configData.mapField.text];}
this.changeCssElRow(item.elRow);}
this.oTextBox.value=textDisplay;this.oldValue=this.oTextBox.value;var elRowCheckAll=this.oTableList.rows[0];elRowCheckAll.cells[0].elementChk.checked=isAll;this.changeCssElRow(elRowCheckAll);};MultiSelectBoxBTD.prototype.selectedAll=function(isCheck){var textDisplay='';for(var i=0;i<this.configData.data.length;i++){var item=this.configData.data[i];var elCell=item.elRow.cells[0];elCell.elementChk.checked=isCheck;if(isCheck){if(textDisplay!="")textDisplay+=this.textSeparator;textDisplay+=item[this.configData.mapField.text];}
this.changeCssElRow(item.elRow);}
this.oTextBox.value=textDisplay;this.oldValue=this.oTextBox.value;var elRowCheckAll=this.oTableList.rows[0];elRowCheckAll.cells[0].elementChk.checked=textDisplay;this.changeCssElRow(elRowCheckAll);};
